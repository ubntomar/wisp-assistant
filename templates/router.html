{% extends 'base.html' %}

{% block title %}Router{% endblock %}

{% block content %}
    <h1>Router: {{ brand }}</h1>

    {% if not network_connected %}
        <div id="network-alert" class="alert alert-danger" role="alert">
            Cable de red desconectado
        </div>
    {% else %}
        <div id="network-alert" class="alert alert-danger" role="alert" style="display: none;">
            Cable de red desconectado
        </div>
    {% endif %}

    {% if any_link_damaged %}
        <div id="link-damaged-alert" class="alert alert-warning" role="alert">
            Puerto o Cable conectado DAÑADO
        </div>
    {% else %}
        <div id="link-damaged-alert" class="alert alert-warning" role="alert" style="display: none;">
            Puerto o Cable conectado DAÑADO
        </div>
    {% endif %}

    <div class="container mt-5">
        
    
        <form id="wifi-config-form" class="needs-validation" novalidate>
            <div class="mb-3">
                <label for="wifi-name" class="form-label">Nuevo nombre de red WiFi</label>
                <input type="text" class="form-control" id="wifi-name" required minlength="1" maxlength="32" pattern="^[a-zA-Z0-9 ]+$">
                <div class="invalid-feedback">
                    El nombre debe tener entre 1 y 32 caracteres y solo puede contener letras, números y espacios.
                </div>  
            </div>
            </div>
            <div class="mb-3">
                <label for="wifi-password" class="form-label">Nueva contraseña WiFi</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="wifi-password" required minlength="8" pattern="^[a-zA-Z0-9]+$">
                    <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                        <i class="bi bi-eye-slash"></i>
                    </button>
                </div>
                <div class="invalid-feedback">
                    La contraseña debe tener al menos 8 caracteres alfanuméricos.
                </div>
            </div>
            <div class="mb-3">
                <label for="wifi-password-confirm" class="form-label">Confirmar contraseña WiFi</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="wifi-password-confirm" required>
                    <button class="btn btn-outline-secondary" type="button" id="togglePasswordConfirm">
                        <i class="bi bi-eye-slash"></i>
                    </button>
                </div>
                <div class="invalid-feedback" id="password-match-feedback">
                    Las contraseñas no coinciden.
                </div>
            </div>
            <button type="submit" class="btn btn-primary" id="submit-btn">Guardar configuración</button>
        </form>
    
    
        <div id="status-message" class="mt-3 alert" role="alert" style="display: none;"></div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('wifi-config-form');
        const submitBtn = document.getElementById('submit-btn');
        const statusMessage = document.getElementById('status-message');
        const passwordInput = document.getElementById('wifi-password');
        const confirmPasswordInput = document.getElementById('wifi-password-confirm');
        const wifiNameInput = document.getElementById('wifi-name');
        const networkAlert = document.getElementById('network-alert');
        const linkDamagedAlert = document.getElementById('link-damaged-alert');

        
        function togglePasswordVisibility(inputField, toggleButton) {
            const type = inputField.getAttribute('type') === 'password' ? 'text' : 'password';
            inputField.setAttribute('type', type);
            toggleButton.querySelector('i').classList.toggle('bi-eye');
            toggleButton.querySelector('i').classList.toggle('bi-eye-slash');
        }

        togglePassword.addEventListener('click', function() {
            togglePasswordVisibility(passwordInput, this);
        });

        togglePasswordConfirm.addEventListener('click', function() {
            togglePasswordVisibility(confirmPasswordInput, this);
        });

        function validatePasswords() {
            const passwordMatchFeedback = document.getElementById('password-match-feedback');
            if (passwordInput.value !== confirmPasswordInput.value) {
                confirmPasswordInput.setCustomValidity("Las contraseñas no coinciden");
                passwordMatchFeedback.style.display = 'block';
            } else {
                confirmPasswordInput.setCustomValidity("");
                passwordMatchFeedback.style.display = 'none';
            }
        }

        passwordInput.addEventListener('input', validatePasswords);
        confirmPasswordInput.addEventListener('input', validatePasswords);

        function updateNetworkStatus() {
            fetch('/update_status')
                .then(response => response.json())
                .then(data => {
                    if (data.network_connected) {
                        networkAlert.style.display = 'none';
                    } else {
                        networkAlert.style.display = 'block';
                    }
                });
        }
    
        function updateLinkDamagedStatus() {
            fetch('/update_status')
                .then(response => response.json())
                .then(data => {
                    if (data.any_link_damaged) {
                        linkDamagedAlert.style.display = 'block';
                    } else {
                        linkDamagedAlert.style.display = 'none';
                    }
                });
        }
    
        setInterval(updateNetworkStatus, 5000);
        setInterval(updateLinkDamagedStatus, 5000);
    
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            event.stopPropagation();
            
            validatePasswords();
            
    
            if (form.checkValidity()) {
                submitBtn.disabled = true;
                statusMessage.style.display = 'none';
    
                const formData = {
                    wifi_name: wifiNameInput.value.trim(),
                    wifi_password: passwordInput.value
                };
    
                fetch('/router/tenda/update_wifi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                })
                .then(response => response.json())
                .then(data => {
                    statusMessage.textContent = data.message;
                    statusMessage.classList.remove('alert-success', 'alert-danger');
                    statusMessage.classList.add(data.success ? 'alert-success' : 'alert-danger');
                    statusMessage.style.display = 'block';
                })
                .catch((error) => {
                    console.error('Error:', error);
                    statusMessage.textContent = 'Ocurrió un error al procesar la solicitud.';
                    statusMessage.classList.remove('alert-success', 'alert-danger');
                    statusMessage.classList.add('alert-danger');
                    statusMessage.style.display = 'block';
                })
                .finally(() => {
                    submitBtn.disabled = false;
                });
            }
    
            form.classList.add('was-validated');
        });
    
        // Initial update
        updateNetworkStatus();
        updateLinkDamagedStatus();
    });
    </script>
{% endblock %}
